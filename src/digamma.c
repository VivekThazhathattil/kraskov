/* Ref: https://github.com/jlizier/jidt/blob/master/cuda/digamma.h */

#include <math.h>
#include "digamma.h"

#ifndef M_PIl
#define M_PIl 3.1415926535897932384626433832795029L
#endif
#ifndef M_GAMMAl
#define M_GAMMAl 0.5772156649015328606065120900824024L
#endif
#ifndef M_LN2l
#define M_LN2l 0.6931471805599453094172321214581766L
#endif

/*-------------------------------------------------------------*/
long double psi(long double x)
/*-------------------------------------------------------------*/
{
  unsigned int n;
  if( x < 0.0L )
    return psi(1.0L-x)+M_PIl/tanl(M_PIl*(1.0L-x)) ;  /* reflection formula */
  else if( x < 1.0L )
    return psi(1.0L+x)-1.0L/x ;
  else if ( x == 1.0L)
    return -M_GAMMAl ;
  else if ( x == 2.0L)
    return 1.0L-M_GAMMAl ;
  else if ( x == 3.0L)
    return 1.5L-M_GAMMAl ;
  else if ( x > 3.0L)
    /* duplication formula */
    return 0.5L*(psi(x/2.0L)+psi((x+1.0L)/2.0L))+M_LN2l ;
  else {
    static long double Kncoe[] = { .30459198558715155634315638246624251L,
      .72037977439182833573548891941219706L, -.12454959243861367729528855995001087L,
      .27769457331927827002810119567456810e-1L, -.67762371439822456447373550186163070e-2L,
      .17238755142247705209823876688592170e-2L, -.44817699064252933515310345718960928e-3L,
      .11793660000155572716272710617753373e-3L, -.31253894280980134452125172274246963e-4L,
      .83173997012173283398932708991137488e-5L, -.22191427643780045431149221890172210e-5L,
      .59302266729329346291029599913617915e-6L, -.15863051191470655433559920279603632e-6L,
      .42459203983193603241777510648681429e-7L, -.11369129616951114238848106591780146e-7L,
      .304502217295931698401459168423403510e-8L, -.81568455080753152802915013641723686e-9L,
      .21852324749975455125936715817306383e-9L, -.58546491441689515680751900276454407e-10L,
      .15686348450871204869813586459513648e-10L, -.42029496273143231373796179302482033e-11L,
      .11261435719264907097227520956710754e-11L, -.30174353636860279765375177200637590e-12L,
      .80850955256389526647406571868193768e-13L, -.21663779809421233144009565199997351e-13L,
      .58047634271339391495076374966835526e-14L, -.15553767189204733561108869588173845e-14L,
      .41676108598040807753707828039353330e-15L, -.11167065064221317094734023242188463e-15L } ;

    register long double Tn_1 = 1.0L ;  /* T_{n-1}(x), started at n=1 */
    register long double Tn = x-2.0L ;  /* T_{n}(x) , started at n=1 */
    register long double resul = Kncoe[0] + Kncoe[1]*Tn ;

    x -= 2.0L ;

    for(n = 2 ; n < sizeof(Kncoe)/sizeof(long double) ;n++)
    {
      const long double Tn1 = 2.0L * x * Tn - Tn_1 ;  /* Chebyshev recursion, Eq. 22.7.4 Abramowitz-Stegun */
      resul += Kncoe[n]*Tn1 ;
      Tn_1 = Tn ;
      Tn = Tn1 ;
    }
    return resul ;
  }
}
